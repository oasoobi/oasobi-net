"use client"
import toast, { Toaster } from 'react-hot-toast';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Form, FormControl, FormItem, FormLabel, FormField, FormMessage, FormDescription } from "@/components/ui/form"
import { Switch } from "@/components/ui/switch"
import { useForm } from 'react-hook-form'
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useState } from "react";
import JSZip from 'jszip';
import { v4 as uuidv4 } from 'uuid';
import SkinCard from "@/components/tools/csg/skin-card";
import { useRef } from "react";

const formSchema = z.object({
	localization_name: z.string().min(1, { message: "スキン名は1文字以上にしてください。" }),
	texture: z.custom<File>()
		.refine((file) => file !== undefined, { message: "ファイルが選択されていません。" })
		.refine((file) => file !== undefined && file.type === "image/png", { message: "使用できる画像はpngのみです" }),
	cape: z.custom<File>().optional().refine((file) => {
		if (file == undefined) return true;
		return file.type === "image/png"
	}, { message: "使用できる画像はpngのみです" }),
	geometry: z.boolean()
});


type Skin = {
	localization_name: string,
	geometry: string,
	texture?: string | undefined
	cape?: string | undefined
	type: "free"
}

type FormSkin = {
	localization_name: string,
	geometry: boolean,
	texture?: File | undefined
	cape?: File | undefined
	uuid?: string | undefined
}

export default function Home() {
	const textureRef = useRef<HTMLInputElement>(null);
	const capeRef = useRef<HTMLInputElement>(null);
	const packNameRef = useRef<HTMLInputElement>(null);
	const [isGenerating, setIsGenerating] = useState<boolean>(false);
	const [packName, setPackName] = useState<string>("");
	const [skins, setSkins] = useState<Skin[]>([]);
	const [formSkins, setFormSkins] = useState<FormSkin[]>([]);
	const [skinImages, setSkinImages] = useState<(string | undefined)[]>([]);
	const [capeImages, setCapeImages] = useState<(string | undefined)[]>([]);

	function sleep(ms: number) {
		return new Promise(resolve => setTimeout(resolve, ms));
	}

	async function handleDownload() {
		if (isGenerating) return;
		if (packName == "") {
			packNameRef.current?.focus();
			toast.error("パック名を指定してください。", { duration: 1000, id: "not_written" });
			return
		};
		if (skins.length < 1) return toast.error("スキンが追加されていません。", { duration: 1000, id: "not_added" });
		setIsGenerating(true);
		const toastId = toast.loading('ファイル生成中...');
		await sleep(800)
		const persona = new JSZip();

		persona.file("manifest.json", `
{
	"header": {
		"version": [
			1,
			0,
			0
		],
		"description": "cape pack",
		"name": "cape skinpack",
		"uuid": "${uuidv4()}"
	},
	"modules": [
		{
			"version": [
				1,
				0,
				0
			],
			"type": "skin_pack",
			"uuid": "${uuidv4()}"
		}
	],
	"format_version": 1
}`);

		persona.file("geometry.json", `{
	"format_version": "1.10.0",
	"geometry.deadmau5": {
		"texturewidth": 64,
		"textureheight": 64,
		"visible_bounds_width": 2,
		"visible_bounds_height": 3,
		"visible_bounds_offset": [0, 1.5, 0],
		"bones": [
			{
				"name": "body",
				"pivot": [0, 24, 0],
				"cubes": [
					{"origin": [-4, 12, -2], "size": [8, 12, 4], "uv": [16, 16]}
				]
			},
			{
				"name": "belt",
				"parent": "body",
				"pivot": [0, 12, 0],
				"cubes": [
					{"origin": [0, 0, 0], "size": [0, 0, 0], "uv": [0, 0]}
				]
			},
			{
				"name": "jacket",
				"parent": "body",
				"pivot": [0, 24, 0],
				"cubes": [
					{"origin": [-4, 12, -2], "size": [8, 12, 4], "uv": [16, 32], "inflate": 0.25}
				]
			},
			{
				"name": "bodyArmorOffset",
				"parent": "body",
				"pivot": [0, 24, 0]
			},
			{
				"name": "waist",
				"parent": "body",
				"pivot": [0, 12, 0]
			},
			{
				"name": "head",
				"pivot": [0, 24, 0],
				"cubes": [
					{"origin": [-4, 24, -4], "size": [8, 8, 8], "uv": [0, 0]},
					{"origin": [2.25, 30.25, 0], "size": [6, 6, 1], "uv": [24, 0]},
					{"origin": [-8.25, 30.25, 0], "size": [6, 6, 1], "uv": [8, 0]}
				]
			},
			{
				"name": "hat",
				"parent": "head",
				"pivot": [0, 24, 0],
				"cubes": [
					{"origin": [-4, 24, -4], "size": [8, 8, 8], "uv": [32, 0], "inflate": 0.5}
				]
			},
			{
				"name": "helmet",
				"parent": "head",
				"pivot": [0, 24, 0],
				"cubes": [
					{"origin": [0, 24, 0], "size": [0, 0, 0], "uv": [0, 0]}
				]
			},
			{
				"name": "helmetArmorOffset",
				"parent": "head",
				"pivot": [0, 24, 0]
			},
			{
				"name": "leftArm",
				"pivot": [5, 22, 0],
				"cubes": [
					{"origin": [4, 12, -2], "size": [4, 12, 4], "uv": [32, 48]}
				]
			},
			{
				"name": "leftArmArmor",
				"parent": "leftArm",
				"pivot": [5, 22, 0],
				"cubes": [
					{"origin": [0, 0, 0], "size": [0, 0, 0], "uv": [0, 0]}
				]
			},
			{
				"name": "leftSleeve",
				"parent": "leftArm",
				"pivot": [5, 22, 0],
				"cubes": [
					{"origin": [4, 12, -2], "size": [4, 12, 4], "uv": [48, 48], "inflate": 0.25}
				]
			},
			{
				"name": "leftArmArmorOffset",
				"parent": "leftArm",
				"pivot": [5, 22, 0]
			},
			{
				"name": "leftItem",
				"parent": "leftArm",
				"pivot": [6, 15, 1]
			},
			{
				"name": "rightArm",
				"pivot": [-5, 22, 0],
				"cubes": [
					{"origin": [-8, 12, -2], "size": [4, 12, 4], "uv": [40, 16]}
				]
			},
			{
				"name": "rightArmArmor",
				"parent": "rightArm",
				"pivot": [-5, 22, 0],
				"cubes": [
					{"origin": [0, 0, 0], "size": [0, 0, 0], "uv": [0, 0]}
				]
			},
			{
				"name": "rightSleeve",
				"parent": "rightArm",
				"pivot": [-5, 22, 0],
				"cubes": [
					{"origin": [-8, 12, -2], "size": [4, 12, 4], "uv": [40, 32], "inflate": 0.25}
				]
			},
			{
				"name": "rightArmArmorOffset",
				"parent": "rightArm",
				"pivot": [-5, 22, 0]
			},
			{
				"name": "rightItem",
				"parent": "rightArm",
				"pivot": [-6, 15, 1]
			},
			{
				"name": "leftLeg",
				"pivot": [1.9, 12, 0],
				"cubes": [
					{"origin": [-0.1, 0, -2], "size": [4, 12, 4], "uv": [16, 48]}
				]
			},
			{
				"name": "leftLegging",
				"parent": "leftLeg",
				"pivot": [1.9, 12, 0],
				"cubes": [
					{"origin": [0, 0, 0], "size": [0, 0, 0], "uv": [0, 0]}
				]
			},
			{
				"name": "leftPants",
				"parent": "leftLeg",
				"pivot": [1.9, 12, 0],
				"cubes": [
					{"origin": [-0.1, 0, -2], "size": [4, 12, 4], "uv": [0, 48], "inflate": 0.25}
				]
			},
			{
				"name": "leftLegArmorOffset",
				"parent": "leftLeg",
				"pivot": [1.9, 12, 0]
			},
			{
				"name": "leftBootArmorOffset",
				"parent": "leftLeg",
				"pivot": [1.9, 12, 0]
			},
			{
				"name": "rightLeg",
				"pivot": [-1.9, 12, 0],
				"cubes": [
					{"origin": [-3.9, 0, -2], "size": [4, 12, 4], "uv": [0, 16]}
				]
			},
			{
				"name": "rightLegging",
				"parent": "rightLeg",
				"pivot": [-1.9, 12, 0],
				"cubes": [
					{"origin": [0, 0, 0], "size": [0, 0, 0], "uv": [0, 0]}
				]
			},
			{
				"name": "rightPants",
				"parent": "rightLeg",
				"pivot": [-1.9, 12, 0],
				"cubes": [
					{"origin": [-3.9, 0, -2], "size": [4, 12, 4], "uv": [0, 32], "inflate": 0.25}
				]
			},
			{
				"name": "rightLegArmorOffset",
				"parent": "rightLeg",
				"pivot": [-1.9, 12, 0]
			},
			{
				"name": "rightBootArmorOffset",
				"parent": "rightLeg",
				"pivot": [-1.9, 12, 0]
			},
			{
				"name": "bodyArmor",
				"pivot": [0, 24, 0],
				"cubes": [
					{"origin": [0, 0, 0], "size": [0, 0, 0], "uv": [0, 0]}
				]
			}
		]
	},
	"geometry.capeX2":{"bones":[{"name":"root","pivot":[0,0,0]},{"name":"body","parent":"waist","pivot":[0,24,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-3.995187,23.971123,1.99761],[-3.995187,11.985561,1.997602],[-3.995187,23.971123,-1.997578],[-3.995187,11.985561,-1.997586],[3.995187,23.971123,-1.997578],[3.995187,11.985561,-1.997586],[3.995187,23.971123,1.99761],[3.995187,11.985561,1.997602]],"uvs":[[0.625,0.34375],[0.625,0.25],[0.78125,0.375],[0.78125,0.34375],[0.71875,0.375],[0.71875,0.34375],[0.8125,0.34375],[0.8125,0.25],[0.65625,0.34375],[0.65625,0.25],[0.71875,0.34375],[0.71875,0.25],[0.75,0.34375],[0.75,0.25],[0.71875,0.375],[0.65625,0.375]],"polys":[[[0,0,0],[1,0,1],[2,0,8],[2,0,8]],[[1,0,1],[3,0,9],[2,0,8],[2,0,8]],[[4,1,10],[5,1,11],[6,1,12],[6,1,12]],[[5,1,11],[7,1,13],[6,1,12],[6,1,12]],[[4,2,10],[6,2,14],[2,2,8],[2,2,8]],[[6,2,14],[0,2,15],[2,2,8],[2,2,8]],[[7,3,2],[5,3,3],[1,3,4],[1,3,4]],[[5,3,3],[3,3,5],[1,3,4],[1,3,4]],[[6,4,12],[7,4,13],[0,4,6],[0,4,6]],[[7,4,13],[1,4,7],[0,4,6],[0,4,6]],[[2,5,8],[3,5,9],[4,5,10],[4,5,10]],[[3,5,9],[5,5,11],[4,5,10],[4,5,10]]]}},{"name":"waist","parent":"root","pivot":[0,12,0]},{"name":"head","parent":"body","pivot":[0,24,0],"poly_mesh":{"normalized_uvs":true,"normals":[[0,0,1],[0,0,-1],[1,0,0],[-1,0,0],[0,1,0],[0,-1,0]],"positions":[[-3.995187,31.961498,-3.995167],[-3.995187,23.971123,-3.995171],[3.995187,31.961498,-3.995167],[3.995187,23.971123,-3.995171],[3.995187,31.961498,3.995208],[3.995187,23.971123,3.995203],[-3.995187,31.961498,3.995208],[-3.995187,23.971123,3.995203]],"uvs":[[0.5,0.4375],[0.5,0.375],[0.5625,0.4375],[0.5625,0.375],[0.625,0.4375],[0.625,0.375],[0.6875,0.4375],[0.6875,0.375],[0.625,0.5],[0.5625,0.5],[0.6875,0.5],[0.6875,0.4375],[0.625,0.5],[0.625,0.4375],[0.75,0.4375],[0.75,0.375]],"polys":[[[6,2,0],[7,2,1],[0,2,2],[0,2,2]],[[7,2,1],[1,2,3],[0,2,2],[0,2,2]],[[2,3,4],[3,3,5],[4,3,6],[4,3,6]],[[3,3,5],[5,3,7],[4,3,6],[4,3,6]],[[2,4,4],[4,4,8],[0,4,2],[0,4,2]],[[4,4,8],[6,4,9],[0,4,2],[0,4,2]],[[5,5,10],[3,5,11],[7,5,12],[7,5,12]],[[3,5,11],[1,5,13],[7,5,12],[7,5,12]],[[4,0,6],[5,0,7],[6,0,14],[6,0,14]],[[5,0,7],[7,0,15],[6,0,14],[6,0,14]],[[0,1,2],[1,1,3],[2,1,4],[2,1,4]],[[1,1,3],[3,1,5],[2,1,4],[2,1,4]]]}},{"name":"cape","pivot":[0,24,3],"rotation":[0,180,0],"parent":"body","poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,-0.0052],[0,1,-0.0055],[0,-1,0.0056],[0,-1,0.0059],[0,0.0049,1],[0,-0.0049,-1]],"positions":[[-4.993984,24.117414,3.122835],[-4.993984,8.236761,3.201288],[-4.993984,24.122959,4.121618],[-4.993984,8.242305,4.20007],[4.993984,24.122959,4.121618],[4.993984,8.242305,4.20007],[4.993984,24.117414,3.122835],[4.993984,8.236761,3.201288]],"uvs":[[0.171875,0.984375],[0.171875,0.734375],[0.1875,0.984375],[0.1875,0.734375],[0,0.984375],[0,0.734375],[0.015625,0.984375],[0.015625,0.734375],[0.171875,0.984375],[0.171875,1],[0.015625,0.984375],[0.015625,1],[0.328125,1],[0.328125,0.984375],[0.171875,1],[0.171875,0.984375],[0.171875,0.984375],[0.171875,0.734375],[0.015625,0.984375],[0.015625,0.734375],[0.34375,0.984375],[0.34375,0.734375],[0.1875,0.984375],[0.1875,0.734375]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,8],[6,3,9],[2,3,10],[2,3,10]],[[6,3,9],[0,3,11],[2,3,10],[2,3,10]],[[7,4,12],[5,4,13],[1,5,14],[1,5,14]],[[5,4,13],[3,4,15],[1,5,14],[1,5,14]],[[6,6,16],[7,6,17],[0,6,18],[0,6,18]],[[7,6,17],[1,6,19],[0,6,18],[0,6,18]],[[2,7,20],[3,7,21],[4,7,22],[4,7,22]],[[3,7,21],[5,7,23],[4,7,22],[4,7,22]]]}},{"name":"hat","parent":"head","pivot":[0,24,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-4.494586,32.460896,4.494606],[-4.494586,23.471725,4.494601],[-4.494586,32.460896,-4.494565],[-4.494586,23.471725,-4.49457],[4.494586,32.460896,-4.494565],[4.494586,23.471725,-4.49457],[4.494586,32.460896,4.494606],[4.494586,23.471725,4.494601]],"uvs":[[0.75,0.4375],[0.75,0.375],[0.8125,0.4375],[0.8125,0.375],[0.875,0.4375],[0.875,0.375],[0.9375,0.4375],[0.9375,0.375],[0.875,0.5],[0.8125,0.5],[0.9375,0.5],[0.9375,0.4375],[0.875,0.5],[0.875,0.4375],[1,0.4375],[1,0.375]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"leftArm","parent":"body","pivot":[5,22,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[3.995187,23.971123,1.99761],[3.995187,11.985561,1.997602],[3.995187,23.971123,-1.997578],[3.995187,11.985561,-1.997586],[7.990375,23.971123,-1.997578],[7.990375,11.985561,-1.997586],[7.990375,23.971123,1.99761],[7.990375,11.985561,1.997602]],"uvs":[[0.75,0.09375],[0.75,0],[0.78125,0.09375],[0.78125,0],[0.8125,0.09375],[0.8125,0],[0.84375,0.09375],[0.84375,0],[0.8125,0.125],[0.78125,0.125],[0.84375,0.125],[0.84375,0.09375],[0.8125,0.125],[0.8125,0.09375],[0.875,0.09375],[0.875,0]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"leftSleeve","parent":"leftArm","pivot":[5,22,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[3.745488,24.220823,2.247309],[3.745488,11.735863,2.247301],[3.745488,24.220823,-2.247277],[3.745488,11.735863,-2.247285],[8.240074,24.220823,-2.247277],[8.240074,11.735863,-2.247285],[8.240074,24.220823,2.247309],[8.240074,11.735863,2.247301]],"uvs":[[0.9375,0.125],[0.9375,0.09375],[1,0.09375],[1,0],[0.875,0.09375],[0.875,0],[0.90625,0.09375],[0.90625,0],[0.9375,0.09375],[0.9375,0],[0.96875,0.09375],[0.96875,0],[0.9375,0.125],[0.90625,0.125],[0.96875,0.125],[0.96875,0.09375]],"polys":[[[0,0,4],[1,0,5],[2,0,6],[2,0,6]],[[1,0,5],[3,0,7],[2,0,6],[2,0,6]],[[4,1,8],[5,1,9],[6,1,10],[6,1,10]],[[5,1,9],[7,1,11],[6,1,10],[6,1,10]],[[4,2,8],[6,2,12],[2,2,6],[2,2,6]],[[6,2,12],[0,2,13],[2,2,6],[2,2,6]],[[7,3,14],[5,3,15],[1,3,0],[1,3,0]],[[5,3,15],[3,3,1],[1,3,0],[1,3,0]],[[6,4,10],[7,4,11],[0,4,2],[0,4,2]],[[7,4,11],[1,4,3],[0,4,2],[0,4,2]],[[2,5,6],[3,5,7],[4,5,8],[4,5,8]],[[3,5,7],[5,5,9],[4,5,8],[4,5,8]]]}},{"name":"leftItem","pivot":[6,15,1],"parent":"leftArm"},{"name":"rightArm","parent":"body","pivot":[-5,22,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-7.990375,23.971123,1.99761],[-7.990375,11.985561,1.997602],[-7.990375,23.971123,-1.997578],[-7.990375,11.985561,-1.997586],[-3.995187,23.971123,-1.997578],[-3.995187,11.985561,-1.997586],[-3.995187,23.971123,1.99761],[-3.995187,11.985561,1.997602]],"uvs":[[0.8125,0.34375],[0.8125,0.25],[0.84375,0.34375],[0.84375,0.25],[0.875,0.34375],[0.875,0.25],[0.90625,0.34375],[0.90625,0.25],[0.875,0.375],[0.84375,0.375],[0.90625,0.375],[0.90625,0.34375],[0.875,0.375],[0.875,0.34375],[0.9375,0.34375],[0.9375,0.25]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"rightSleeve","parent":"rightArm","pivot":[-5,22,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-8.240074,24.220823,2.247309],[-8.240074,11.735863,2.247301],[-8.240074,24.220823,-2.247277],[-8.240074,11.735863,-2.247285],[-3.745488,24.220823,-2.247277],[-3.745488,11.735863,-2.247285],[-3.745488,24.220823,2.247309],[-3.745488,11.735863,2.247301]],"uvs":[[0.8125,0.21875],[0.8125,0.125],[0.84375,0.21875],[0.84375,0.125],[0.875,0.21875],[0.875,0.125],[0.90625,0.21875],[0.90625,0.125],[0.875,0.25],[0.84375,0.25],[0.90625,0.25],[0.90625,0.21875],[0.875,0.25],[0.875,0.21875],[0.9375,0.21875],[0.9375,0.125]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"rightItem","pivot":[-6,15,1],"locators":{"lead_hold":[-6,15,1]},"parent":"rightArm"},{"name":"leftLeg","parent":"root","pivot":[1.9,12,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-0.09988,11.985561,1.997602],[-0.09988,0,1.997594],[-0.09988,11.985561,-1.997586],[-0.09988,0,-1.997594],[3.895308,11.985561,-1.997586],[3.895308,0,-1.997594],[3.895308,11.985561,1.997602],[3.895308,0,1.997594]],"uvs":[[0.625,0.09375],[0.625,0],[0.65625,0.09375],[0.65625,0],[0.6875,0.09375],[0.6875,0],[0.71875,0.09375],[0.71875,0],[0.6875,0.125],[0.65625,0.125],[0.71875,0.125],[0.71875,0.09375],[0.6875,0.125],[0.6875,0.09375],[0.75,0.09375],[0.75,0]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"leftPants","parent":"leftLeg","pivot":[1.9,12,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-0.349579,12.235261,2.247301],[-0.349579,-0.2497,2.247293],[-0.349579,12.235261,-2.247285],[-0.349579,-0.249699,-2.247293],[4.145007,12.235261,-2.247285],[4.145007,-0.249699,-2.247293],[4.145007,12.235261,2.247301],[4.145007,-0.2497,2.247293]],"uvs":[[0.5,0.09375],[0.5,0],[0.53125,0.09375],[0.53125,0],[0.5625,0.09375],[0.5625,0],[0.59375,0.09375],[0.59375,0],[0.5625,0.125],[0.53125,0.125],[0.59375,0.125],[0.59375,0.09375],[0.5625,0.125],[0.5625,0.09375],[0.625,0.09375],[0.625,0]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"rightLeg","parent":"root","pivot":[-1.9,12,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-3.895308,11.985561,1.997602],[-3.895308,0,1.997594],[-3.895308,11.985561,-1.997586],[-3.895308,0,-1.997594],[0.09988,11.985561,-1.997586],[0.09988,0,-1.997594],[0.09988,11.985561,1.997602],[0.09988,0,1.997594]],"uvs":[[0.5,0.34375],[0.5,0.25],[0.53125,0.34375],[0.53125,0.25],[0.5625,0.34375],[0.5625,0.25],[0.59375,0.34375],[0.59375,0.25],[0.5625,0.375],[0.53125,0.375],[0.59375,0.375],[0.59375,0.34375],[0.5625,0.375],[0.5625,0.34375],[0.625,0.34375],[0.625,0.25]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"rightPants","parent":"rightLeg","pivot":[-1.9,12,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[0.349579,12.235261,-2.247285],[0.349579,-0.249699,-2.247293],[0.349579,12.235261,2.247301],[0.349579,-0.2497,2.247293],[-4.145007,12.235261,2.247301],[-4.145007,-0.2497,2.247293],[-4.145007,12.235261,-2.247285],[-4.145007,-0.249699,-2.247293]],"uvs":[[0.5,0.21875],[0.5,0.125],[0.53125,0.21875],[0.53125,0.125],[0.5625,0.21875],[0.5625,0.125],[0.59375,0.21875],[0.59375,0.125],[0.5625,0.25],[0.53125,0.25],[0.59375,0.25],[0.59375,0.21875],[0.5625,0.25],[0.5625,0.21875],[0.625,0.21875],[0.625,0.125]],"polys":[[[4,0,0],[5,0,1],[6,0,2],[6,0,2]],[[5,0,1],[7,0,3],[6,0,2],[6,0,2]],[[0,1,4],[1,1,5],[2,1,6],[2,1,6]],[[1,1,5],[3,1,7],[2,1,6],[2,1,6]],[[0,2,4],[2,2,8],[6,2,2],[6,2,2]],[[2,2,8],[4,2,9],[6,2,2],[6,2,2]],[[3,3,10],[1,3,11],[5,3,12],[5,3,12]],[[1,3,11],[7,3,13],[5,3,12],[5,3,12]],[[2,4,6],[3,4,7],[4,4,14],[4,4,14]],[[3,4,7],[5,4,15],[4,4,14],[4,4,14]],[[6,5,2],[7,5,3],[0,5,4],[0,5,4]],[[7,5,3],[1,5,5],[0,5,4],[0,5,4]]]}},{"name":"jacket","parent":"body","pivot":[0,24,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-4.244886,24.220823,2.247309],[-4.244886,11.735863,2.247301],[-4.244886,24.220823,-2.247277],[-4.244886,11.735863,-2.247285],[4.244886,24.220823,-2.247277],[4.244886,11.735863,-2.247285],[4.244886,24.220823,2.247309],[4.244886,11.735863,2.247301]],"uvs":[[0.625,0.21875],[0.625,0.125],[0.65625,0.21875],[0.65625,0.125],[0.71875,0.21875],[0.71875,0.125],[0.75,0.21875],[0.75,0.125],[0.71875,0.25],[0.65625,0.25],[0.78125,0.25],[0.78125,0.21875],[0.71875,0.25],[0.71875,0.21875],[0.8125,0.21875],[0.8125,0.125]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}}],"texturewidth":128,"textureheight":128},

	"geometry.capeX5":{"bones":[{"name":"root","pivot":[0,0,0]},{"name":"body","parent":"waist","pivot":[0,24,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-3.995187,23.971123,1.997614],[-3.995187,11.985561,1.997604],[-3.995187,23.971123,-1.997574],[-3.995187,11.985561,-1.997584],[3.995187,23.971123,-1.997574],[3.995187,11.985561,-1.997584],[3.995187,23.971123,1.997614],[3.995187,11.985561,1.997604]],"uvs":[[0.125,0.84375],[0.125,0.75],[0.28125,0.875],[0.28125,0.84375],[0.21875,0.875],[0.21875,0.84375],[0.3125,0.84375],[0.3125,0.75],[0.15625,0.84375],[0.15625,0.75],[0.21875,0.84375],[0.21875,0.75],[0.25,0.84375],[0.25,0.75],[0.21875,0.875],[0.15625,0.875]],"polys":[[[0,0,0],[1,0,1],[2,0,8],[2,0,8]],[[1,0,1],[3,0,9],[2,0,8],[2,0,8]],[[4,1,10],[5,1,11],[6,1,12],[6,1,12]],[[5,1,11],[7,1,13],[6,1,12],[6,1,12]],[[4,2,10],[6,2,14],[2,2,8],[2,2,8]],[[6,2,14],[0,2,15],[2,2,8],[2,2,8]],[[7,3,2],[5,3,3],[1,3,4],[1,3,4]],[[5,3,3],[3,3,5],[1,3,4],[1,3,4]],[[6,4,12],[7,4,13],[0,4,6],[0,4,6]],[[7,4,13],[1,4,7],[0,4,6],[0,4,6]],[[2,5,8],[3,5,9],[4,5,10],[4,5,10]],[[3,5,9],[5,5,11],[4,5,10],[4,5,10]]]}},{"name":"waist","parent":"root","pivot":[0,12,0]},{"name":"head","parent":"body","pivot":[0,24,0],"poly_mesh":{"normalized_uvs":true,"normals":[[0,0,1],[0,0,-1],[1,0,0],[-1,0,0],[0,1,0],[0,-1,0]],"positions":[[-3.995187,31.961498,-3.995162],[-3.995187,23.971123,-3.995167],[3.995187,31.961498,-3.995162],[3.995187,23.971123,-3.995167],[3.995187,31.961498,3.995213],[3.995187,23.971123,3.995207],[-3.995187,31.961498,3.995213],[-3.995187,23.971123,3.995207]],"uvs":[[0,0.9375],[0,0.875],[0.0625,0.9375],[0.0625,0.875],[0.125,0.9375],[0.125,0.875],[0.1875,0.9375],[0.1875,0.875],[0.125,1],[0.0625,1],[0.1875,1],[0.1875,0.9375],[0.125,1],[0.125,0.9375],[0.25,0.9375],[0.25,0.875]],"polys":[[[6,2,0],[7,2,1],[0,2,2],[0,2,2]],[[7,2,1],[1,2,3],[0,2,2],[0,2,2]],[[2,3,4],[3,3,5],[4,3,6],[4,3,6]],[[3,3,5],[5,3,7],[4,3,6],[4,3,6]],[[2,4,4],[4,4,8],[0,4,2],[0,4,2]],[[4,4,8],[6,4,9],[0,4,2],[0,4,2]],[[5,5,10],[3,5,11],[7,5,12],[7,5,12]],[[3,5,11],[1,5,13],[7,5,12],[7,5,12]],[[4,0,6],[5,0,7],[6,0,14],[6,0,14]],[[5,0,7],[7,0,15],[6,0,14],[6,0,14]],[[0,1,2],[1,1,3],[2,1,4],[2,1,4]],[[1,1,3],[3,1,5],[2,1,4],[2,1,4]]]}},{"name":"cape","pivot":[0,24,3],"rotation":[0,180,0],"parent":"body","poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,-0.0052],[0,1,-0.0055],[0,-1,0.0056],[0,0.0049,1],[0,-0.0049,-1]],"positions":[[-4.993984,24.117414,3.122839],[-4.993984,8.23676,3.201289],[-4.993984,24.122959,4.121622],[-4.993984,8.242304,4.200071],[4.993984,24.122959,4.121622],[4.993984,8.242304,4.200071],[4.993984,24.117414,3.122839],[4.993984,8.23676,3.201289]],"uvs":[[0.578125,0.625],[0.578125,0],[0.609375,0.625],[0.609375,0],[0.140625,0.625],[0.140625,0],[0.179688,0.625],[0.179688,0],[0.570312,0.625],[0.570312,0.664062],[0.179688,0.625],[0.179688,0.664062],[0.960938,0.664062],[0.960938,0.625],[0.578125,0.664062],[0.578125,0.625],[0.578125,0.625],[0.578125,0],[0.179688,0.625],[0.179688,0],[1,0.625],[1,0],[0.609375,0.625],[0.609375,0]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,8],[6,3,9],[2,3,10],[2,3,10]],[[6,3,9],[0,3,11],[2,3,10],[2,3,10]],[[7,4,12],[5,4,13],[1,4,14],[1,4,14]],[[5,4,13],[3,4,15],[1,4,14],[1,4,14]],[[6,5,16],[7,5,17],[0,5,18],[0,5,18]],[[7,5,17],[1,5,19],[0,5,18],[0,5,18]],[[2,6,20],[3,6,21],[4,6,22],[4,6,22]],[[3,6,21],[5,6,23],[4,6,22],[4,6,22]]]}},{"name":"hat","parent":"head","pivot":[0,24,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-4.494586,32.460896,4.494611],[-4.494586,23.471725,4.494605],[-4.494586,32.460896,-4.49456],[-4.494586,23.471725,-4.494566],[4.494586,32.460896,-4.49456],[4.494586,23.471725,-4.494566],[4.494586,32.460896,4.494611],[4.494586,23.471725,4.494605]],"uvs":[[0.25,0.9375],[0.25,0.875],[0.3125,0.9375],[0.3125,0.875],[0.375,0.9375],[0.375,0.875],[0.4375,0.9375],[0.4375,0.875],[0.375,1],[0.3125,1],[0.4375,1],[0.4375,0.9375],[0.375,1],[0.375,0.9375],[0.5,0.9375],[0.5,0.875]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"leftArm","parent":"body","pivot":[5,22,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[3.995187,23.971123,1.997614],[3.995187,11.985561,1.997604],[3.995187,23.971123,-1.997574],[3.995187,11.985561,-1.997584],[7.990375,23.971123,-1.997574],[7.990375,11.985561,-1.997584],[7.990375,23.971123,1.997614],[7.990375,11.985561,1.997604]],"uvs":[[0.75,0.84375],[0.75,0.75],[0.78125,0.84375],[0.78125,0.75],[0.8125,0.84375],[0.8125,0.75],[0.84375,0.84375],[0.84375,0.75],[0.8125,0.875],[0.78125,0.875],[0.84375,0.875],[0.84375,0.84375],[0.8125,0.875],[0.8125,0.84375],[0.875,0.84375],[0.875,0.75]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"leftSleeve","parent":"leftArm","pivot":[5,22,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[3.745488,24.220823,2.247313],[3.745488,11.735863,2.247303],[3.745488,24.220823,-2.247273],[3.745488,11.735863,-2.247283],[8.240074,24.220823,-2.247273],[8.240074,11.735863,-2.247283],[8.240074,24.220823,2.247313],[8.240074,11.735863,2.247303]],"uvs":[[0.9375,0.875],[0.9375,0.84375],[1,0.84375],[1,0.75],[0.875,0.84375],[0.875,0.75],[0.90625,0.84375],[0.90625,0.75],[0.9375,0.84375],[0.9375,0.75],[0.96875,0.84375],[0.96875,0.75],[0.9375,0.875],[0.90625,0.875],[0.96875,0.875],[0.96875,0.84375]],"polys":[[[0,0,4],[1,0,5],[2,0,6],[2,0,6]],[[1,0,5],[3,0,7],[2,0,6],[2,0,6]],[[4,1,8],[5,1,9],[6,1,10],[6,1,10]],[[5,1,9],[7,1,11],[6,1,10],[6,1,10]],[[4,2,8],[6,2,12],[2,2,6],[2,2,6]],[[6,2,12],[0,2,13],[2,2,6],[2,2,6]],[[7,3,14],[5,3,15],[1,3,0],[1,3,0]],[[5,3,15],[3,3,1],[1,3,0],[1,3,0]],[[6,4,10],[7,4,11],[0,4,2],[0,4,2]],[[7,4,11],[1,4,3],[0,4,2],[0,4,2]],[[2,5,6],[3,5,7],[4,5,8],[4,5,8]],[[3,5,7],[5,5,9],[4,5,8],[4,5,8]]]}},{"name":"leftItem","pivot":[6,15,1],"parent":"leftArm"},{"name":"rightArm","parent":"body","pivot":[-5,22,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-7.990375,23.971123,1.997614],[-7.990375,11.985561,1.997604],[-7.990375,23.971123,-1.997574],[-7.990375,11.985561,-1.997584],[-3.995187,23.971123,-1.997574],[-3.995187,11.985561,-1.997584],[-3.995187,23.971123,1.997614],[-3.995187,11.985561,1.997604]],"uvs":[[0.3125,0.84375],[0.3125,0.75],[0.34375,0.84375],[0.34375,0.75],[0.375,0.84375],[0.375,0.75],[0.40625,0.84375],[0.40625,0.75],[0.375,0.875],[0.34375,0.875],[0.40625,0.875],[0.40625,0.84375],[0.375,0.875],[0.375,0.84375],[0.4375,0.84375],[0.4375,0.75]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"rightSleeve","parent":"rightArm","pivot":[-5,22,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-8.240074,24.220823,2.247313],[-8.240074,11.735863,2.247303],[-8.240074,24.220823,-2.247273],[-8.240074,11.735863,-2.247283],[-3.745488,24.220823,-2.247273],[-3.745488,11.735863,-2.247283],[-3.745488,24.220823,2.247313],[-3.745488,11.735863,2.247303]],"uvs":[[0.8125,0.96875],[0.8125,0.875],[0.84375,0.96875],[0.84375,0.875],[0.875,0.96875],[0.875,0.875],[0.90625,0.96875],[0.90625,0.875],[0.875,1],[0.84375,1],[0.90625,1],[0.90625,0.96875],[0.875,1],[0.875,0.96875],[0.9375,0.96875],[0.9375,0.875]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"rightItem","pivot":[-6,15,1],"locators":{"lead_hold":[-6,15,1]},"parent":"rightArm"},{"name":"leftLeg","parent":"root","pivot":[1.9,12,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-0.09988,11.985561,1.997604],[-0.09988,0,1.997594],[-0.09988,11.985561,-1.997584],[-0.09988,0,-1.997594],[3.895308,11.985561,-1.997584],[3.895308,0,-1.997594],[3.895308,11.985561,1.997604],[3.895308,0,1.997594]],"uvs":[[0.625,0.84375],[0.625,0.75],[0.65625,0.84375],[0.65625,0.75],[0.6875,0.84375],[0.6875,0.75],[0.71875,0.84375],[0.71875,0.75],[0.6875,0.875],[0.65625,0.875],[0.71875,0.875],[0.71875,0.84375],[0.6875,0.875],[0.6875,0.84375],[0.75,0.84375],[0.75,0.75]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"leftPants","parent":"leftLeg","pivot":[1.9,12,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-0.349579,12.235261,2.247303],[-0.349579,-0.2497,2.247293],[-0.349579,12.235261,-2.247283],[-0.349579,-0.249699,-2.247293],[4.145007,12.235261,-2.247283],[4.145007,-0.249699,-2.247293],[4.145007,12.235261,2.247303],[4.145007,-0.2497,2.247293]],"uvs":[[0.5,0.96875],[0.5,0.875],[0.53125,0.96875],[0.53125,0.875],[0.5625,0.96875],[0.5625,0.875],[0.59375,0.96875],[0.59375,0.875],[0.5625,1],[0.53125,1],[0.59375,1],[0.59375,0.96875],[0.5625,1],[0.5625,0.96875],[0.625,0.96875],[0.625,0.875]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"rightLeg","parent":"root","pivot":[-1.9,12,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-3.895308,11.985561,1.997604],[-3.895308,0,1.997594],[-3.895308,11.985561,-1.997584],[-3.895308,0,-1.997594],[0.09988,11.985561,-1.997584],[0.09988,0,-1.997594],[0.09988,11.985561,1.997604],[0.09988,0,1.997594]],"uvs":[[0,0.84375],[0,0.75],[0.03125,0.84375],[0.03125,0.75],[0.0625,0.84375],[0.0625,0.75],[0.09375,0.84375],[0.09375,0.75],[0.0625,0.875],[0.03125,0.875],[0.09375,0.875],[0.09375,0.84375],[0.0625,0.875],[0.0625,0.84375],[0.125,0.84375],[0.125,0.75]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}},{"name":"rightPants","parent":"rightLeg","pivot":[-1.9,12,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[0.349579,12.235261,-2.247283],[0.349579,-0.249699,-2.247293],[0.349579,12.235261,2.247303],[0.349579,-0.2497,2.247293],[-4.145007,12.235261,2.247303],[-4.145007,-0.2497,2.247293],[-4.145007,12.235261,-2.247283],[-4.145007,-0.249699,-2.247293]],"uvs":[[0.5,0.84375],[0.5,0.75],[0.53125,0.84375],[0.53125,0.75],[0.5625,0.84375],[0.5625,0.75],[0.59375,0.84375],[0.59375,0.75],[0.5625,0.875],[0.53125,0.875],[0.59375,0.875],[0.59375,0.84375],[0.5625,0.875],[0.5625,0.84375],[0.625,0.84375],[0.625,0.75]],"polys":[[[4,0,0],[5,0,1],[6,0,2],[6,0,2]],[[5,0,1],[7,0,3],[6,0,2],[6,0,2]],[[0,1,4],[1,1,5],[2,1,6],[2,1,6]],[[1,1,5],[3,1,7],[2,1,6],[2,1,6]],[[0,2,4],[2,2,8],[6,2,2],[6,2,2]],[[2,2,8],[4,2,9],[6,2,2],[6,2,2]],[[3,3,10],[1,3,11],[5,3,12],[5,3,12]],[[1,3,11],[7,3,13],[5,3,12],[5,3,12]],[[2,4,6],[3,4,7],[4,4,14],[4,4,14]],[[3,4,7],[5,4,15],[4,4,14],[4,4,14]],[[6,5,2],[7,5,3],[0,5,4],[0,5,4]],[[7,5,3],[1,5,5],[0,5,4],[0,5,4]]]}},{"name":"jacket","parent":"body","pivot":[0,24,0],"poly_mesh":{"normalized_uvs":true,"normals":[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],"positions":[[-4.244886,24.220823,2.247313],[-4.244886,11.735863,2.247303],[-4.244886,24.220823,-2.247273],[-4.244886,11.735863,-2.247283],[4.244886,24.220823,-2.247273],[4.244886,11.735863,-2.247283],[4.244886,24.220823,2.247313],[4.244886,11.735863,2.247303]],"uvs":[[0.625,0.96875],[0.625,0.875],[0.65625,0.96875],[0.65625,0.875],[0.71875,0.96875],[0.71875,0.875],[0.75,0.96875],[0.75,0.875],[0.71875,1],[0.65625,1],[0.78125,1],[0.78125,0.96875],[0.71875,1],[0.71875,0.96875],[0.8125,0.96875],[0.8125,0.875]],"polys":[[[0,0,0],[1,0,1],[2,0,2],[2,0,2]],[[1,0,1],[3,0,3],[2,0,2],[2,0,2]],[[4,1,4],[5,1,5],[6,1,6],[6,1,6]],[[5,1,5],[7,1,7],[6,1,6],[6,1,6]],[[4,2,4],[6,2,8],[2,2,2],[2,2,2]],[[6,2,8],[0,2,9],[2,2,2],[2,2,2]],[[7,3,10],[5,3,11],[1,3,12],[1,3,12]],[[5,3,11],[3,3,13],[1,3,12],[1,3,12]],[[6,4,6],[7,4,7],[0,4,14],[0,4,14]],[[7,4,7],[1,4,15],[0,4,14],[0,4,14]],[[2,5,2],[3,5,3],[4,5,4],[4,5,4]],[[3,5,3],[5,5,5],[4,5,4],[4,5,4]]]}}],"texturewidth":128,"textureheight":128}}`);

		persona.file("skins.json", `
{
	"skins": ${JSON.stringify(skins)},
	"serialize_name": "${packName}",
	"localization_name": "${packName}"
}`
		);

		const seenTextures = new Set<string>();
		const addTexturesIndexList: number[] = [];
		skins.forEach((skin, index) => {
			if (!seenTextures.has(skin.texture || "")) {
				addTexturesIndexList.push(index);
			} else {
				if (addTexturesIndexList.includes(skins.indexOf(skin))) {
					return;
				} else {
					addTexturesIndexList.push(skins.indexOf(skin));
				}
			}
		})
		const fetchImagePromises = addTexturesIndexList.map(async (index) => {
			try {
				const response = await fetch(skinImages[index] || "");
				if (!response.ok) {
					console.error('Failed to fetch image:', response.statusText);
					return;
				}
				const blob = await response.blob();
				const arrayBuffer = await blob.arrayBuffer();
				persona.file(skins[index].texture || "image.png", arrayBuffer);
			} catch (error) {
				console.error('Error adding file to ZIP:', error);
			}
		});

		await Promise.all(fetchImagePromises);

		const seenCapes = new Set<string>();
		const addCapesIndexList: number[] = [];
		skins.forEach((skin, index) => {
			if (skin.cape) {
				if (!seenCapes.has(skin.cape || "")) {
					addCapesIndexList.push(index);
				} else {
					if (addCapesIndexList.includes(skins.indexOf(skin))) {
						return;
					} else {
						addCapesIndexList.push(skins.indexOf(skin));
					}
				}
			} else return;
		})

		const fetchCapesPromises = addCapesIndexList.map(async (index) => {
			try {
				const response = await fetch(capeImages[index] || "");
				if (!response.ok) {
					console.error('Failed to fetch image:', response.statusText);
					return;
				}
				const blob = await response.blob();
				const arrayBuffer = await blob.arrayBuffer();
				persona.file(skins[index].cape || "image.png", arrayBuffer);
			} catch (error) {
				console.error('Error adding file to ZIP:', error);
			}
		});

		await Promise.all(fetchCapesPromises);

		persona.generateAsync({ type: "blob" }).then((content) => {
			const a = document.createElement("a");
			a.href = URL.createObjectURL(content);
			a.download = "persona.zip";
			a.click();
		})

		toast.success('ダウンロードしました！', {
			id: toastId,
		});
		setIsGenerating(false);
	}

	function onSubmit(data: FormSkin) {
		toast.success("追加しました。", { duration: 2000 });
		const newData = {
			localization_name: data.localization_name,
			geometry: data.geometry,
			texture: data.texture,
			cape: data.cape,
			uuid: uuidv4()
		}
		const skin: Skin = {
			"localization_name": data.localization_name,
			"geometry": `geometry.humanoid.custom${data.geometry ? "Slim" : ""}`, //geoがalexのときにSlimを追加。
			"texture": data.texture?.name,
			...(data.cape && { "cape": data.cape.name }),
			"type": "free"
		}
		const textureUrl = data.texture ? URL.createObjectURL(data.texture) : undefined;
		const capeUrl = data.cape ? URL.createObjectURL(data.cape) : undefined;
		setSkinImages([...skinImages, textureUrl]);
		setCapeImages([...capeImages, capeUrl]);
		setSkins([...skins, skin]);
		setFormSkins([...formSkins, newData]);

		form.reset({
			"localization_name": "",
			"geometry": false,
			"texture": undefined,
			"cape": undefined
		})

		if (textureRef.current) textureRef.current.value = ""; //ファイルの方も初期化
		if (capeRef.current) capeRef.current.value = "";
	}
	const form = useForm({
		resolver: zodResolver(formSchema),
		defaultValues: {
			"localization_name": "",
			"geometry": false,
			"texture": undefined,
			"cape": undefined
		}
	});

	const deleteSkin = (uuid: string, texture: string, cape: string | undefined) => {
		toast.success("削除しました。", { duration: 2000});
		const newSkinImages = [...skinImages];
		const newCapeImages = [...capeImages];
		const newFormSkins = [...formSkins];
		const newSkins = [...skins];
		URL.revokeObjectURL(texture);
		if (cape !== undefined) URL.revokeObjectURL(cape);
		const index = formSkins.findIndex(skin => skin.uuid === uuid);
		newFormSkins.splice(index, 1); // 該当する要素を削除
		newSkins.splice(index, 1);
		newSkinImages.splice(index, 1);
		newCapeImages.splice(index, 1);
		setFormSkins(newFormSkins);
		setSkins(newSkins);
		URL.revokeObjectURL(skinImages[index] || "");
		URL.revokeObjectURL(capeImages[index] || "");
		setSkinImages(newSkinImages);
		setCapeImages(newCapeImages);
	}

	function onReset() {
		form.reset({
			"localization_name": "",
			"geometry": false,
			"texture": undefined,
			"cape": undefined
		})

		if (textureRef.current) textureRef.current.value = ""; //ファイルの方も初期化
		if (capeRef.current) capeRef.current.value = "";
	}

	return (
		<main className="min-h-svh pt-[6rem] w-screen flex justify-center">
			<div>
				<title>SkinPackGenerator | oasobi</title>
				<meta name="description" content="マイクラ統合版向けのマント付きのスキンパックを生成するツール" />
			</div>
			<Toaster />
			<div className="pl-5 pr-5 w-full lg:pl-20 lg:pr-20 lg:w-3/4">
				<div className="select-none">
					<h1 className="text-3xl font-bold mb-5">Skin Pack Generator</h1>
					<div className="flex gap-2">
						<Input placeholder="スキンパック名" className="w-full" value={packName} onChange={(e) => { setPackName(e.currentTarget.value) }} ref={packNameRef} />
						<Button onClick={handleDownload}>ダウンロード</Button>
					</div>

					<div className="flex mt-5 overflow-x-scroll w-auto gap-3 scrollbar">
						{formSkins.map((skin, index) => <SkinCard skin={skin} deletefunc={deleteSkin} textureUrl={skinImages[index]} capeUrl={capeImages[index]} key={skin.uuid} />)}
					</div>
					<div className="border p-4 rounded-lg mt-5">
						<Form {...form}>
							<form onSubmit={form.handleSubmit(onSubmit)} onReset={onReset} className="w-full space-y-6">
								<div className="space-y-4">
									<FormField
										control={form.control}
										name="localization_name"
										render={({ field }) => (
											<>
												<FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
													<div className="space-y-0.5">
														<FormLabel className="text-base">
															スキン名
														</FormLabel>
														<FormMessage />
													</div>
													<FormControl>
														<Input placeholder='スキン名' type='text' {...field} className='w-3/5'></Input>
													</FormControl>
												</FormItem>
											</>
										)}
									/>
									<FormField
										control={form.control}
										name="texture"
										render={({ field: { onChange, value, ...fieldProps } }) => (
											<>
												<FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
													<div className="space-y-0.5">
														<FormLabel className="text-base">スキン</FormLabel>
														<FormMessage />
													</div>
													<FormControl>
														<Input type='file' accept='.png' {...fieldProps} onChange={(event) => {
															onChange(event.target.files && event.target.files[0])
														}} className='w-3/5' ref={textureRef}></Input>
													</FormControl>
												</FormItem>
											</>
										)}
									/>
									<FormField
										control={form.control}
										name="cape"
										render={({ field: { onChange, value, ...fieldProps } }) => (
											<>
												<FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
													<div className="space-y-0.5">
														<FormLabel className="text-base">マント</FormLabel>
														<FormMessage />
													</div>
													<FormControl>
														<Input type='file' accept='.png' {...fieldProps} onChange={(event) => {
															onChange(event.target.files && event.target.files[0])
														}} className='w-3/5' ref={capeRef}></Input>
													</FormControl>
												</FormItem>
											</>
										)}
									/>
									<FormField
										control={form.control}
										name="geometry"
										render={({ field }) => (
											<>
												<FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
													<div className="space-y-0.5">
														<FormLabel className="text-base">スリムスキン</FormLabel>
														<FormDescription>
															腕の太さが変わります。
														</FormDescription>
														<FormMessage />
													</div>
													<FormControl>
														<Switch
															checked={field.value}
															onCheckedChange={(checked) => {
																form.setValue("geometry", checked);
															}}
														/>
													</FormControl>
												</FormItem>
											</>
										)}
									/>
									<div className='flex items-center gap-3'>
										<Button type='submit'>スキンを追加</Button>
										<Button variant={"outline"} type="reset">リセット</Button>
									</div>
								</div>
							</form>
						</Form>
					</div>
				</div>
				<p className='mt-2 select-none'>処理はすべてブラウザ内で行われます。サーバーにデータが送信されたり、保存されることはありません。</p>
			</div>
		</main >
	);
}
